<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="王星星"><title>Tomcat中websocket的使用和原理 · 王星星的魔灯</title><meta name="description" content="WebSocket是基于tcp的一种全双工通信的协议，它在建立连接的时候需要使用http协议，之后开始连接之后会独立出来。通常，http的每次连接都需要建立在url之上，但是webSocket只需要一个url来建立握手。常见的webSocket有多种实现方式，如SpringBoot+tomcat，或"><meta name="keywords" content="王星星的魔灯,博客,王星星"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><!-- 增加网站logo--><link rel="shortcut icon" href="/assets/img/favicon.ico" type="image/x-icon"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">王星星的魔灯</a></h3><div class="description"><p>勇士斗恶龙 <br> Love & Seriousness & Regularity & Persistence</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/wxxlamp"><i class="fa fa-github"></i></a></li><li><a href="mailto:stalern2000@163.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2305450070&amp;site=qq&amp;menu=yes"><i class="fa fa-qq"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/xiao-ming-91-8-39"><i class="fa fa-mortar-board"></i></a></li></ul><div class="footer"><div class="p"><span>© 2018 - 2021</span><i class="fa fa-star"></i><span> 王星星</span><!--span.leancloud_visitors--></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a><span> &</span><a href="https://github.com/wxxlamp/anatole-core-wxx" target="_blank">Anatole-Wxx</a></div><div class="beian"><a href="http://www.beian.miit.gov.cn/" target="_blank">豫ICP备20004458号-1</a><span style="height:10px;margin-left: 10px;">|</span><img src="/images/gongan.png" style="height:10px;margin-left: 10px;position: relative;top: 1px;"><span style="margin-left: 2px;">豫公网安备 44030400004458号</span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/categories">分类</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/link">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Tomcat中websocket的使用和原理</a></h3></div><div class="post-content"><p>WebSocket是基于tcp的一种全双工通信的协议，它在建立连接的时候需要使用http协议，之后开始连接之后会独立出来。通常，http的每次连接都需要建立在url之上，但是webSocket只需要一个url来建立握手。常见的webSocket有多种实现方式，如SpringBoot+tomcat，或者是springboot+netty</p>
<a id="more"></a>


<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><blockquote>
<p>以下的代码均是基于Spring+tomcat</p>
</blockquote>
<p>首先会在socket那里协商ServerEndPoint注解，然后注解出几个方法，如@BeforeHandshake, @OnOpen, @OnClose, @OnMessage 等等，然后在这些注解方法当中实现响应的业务逻辑。之后在前端页面开启socket即可。<br>对于后台来说，每个链接都是一个session，一般我们会把每个用户的session保留下来，以此来实现一对一和一对多的通信</p>
<h4 id="1-后台代码"><a href="#1-后台代码" class="headerlink" title="1. 后台代码"></a>1. 后台代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServerEndpointExporter <span class="title">serverEndpointExporter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServerEndpointExporter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/webSocket/&#123;page&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatSocket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOG = LoggerFactory.getLogger(TomcatSocket.class);</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(<span class="meta">@PathParam(&quot;page&quot;)</span> String page, Session session)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="meta">@PathParam(&quot;page&quot;)</span> String page, Session session)</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(<span class="meta">@PathParam(&quot;page&quot;)</span> String page, Session session, String message)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;接受到用户&#123;&#125;的数据:&#123;&#125;&quot;</span>,session.getId(),message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable throwable)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> throwable;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;未知错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.wxxlamp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>YeautyTest<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义公共资源版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-前端代码"><a href="#2-前端代码" class="headerlink" title="2. 前端代码"></a>2. 前端代码</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;send()&quot;</span>&gt;</span>发送测试<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;clos()&quot;</span>&gt;</span>关闭连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;message&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> websocket = <span class="literal">null</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span>(<span class="string">&#x27;WebSocket&#x27;</span> <span class="keyword">in</span> <span class="built_in">window</span>)&#123;</span></span><br><span class="line"><span class="javascript">        websocket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;ws://127.0.0.1:8080/webSocket/1&quot;</span>);</span></span><br><span class="line"><span class="javascript">    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">        alert(<span class="string">&quot;您的浏览器不支持websocket&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    websocket.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        setMessageInHtml(<span class="string">&quot;send error！&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    websocket.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        setMessageInHtml(<span class="string">&quot;连接成功！&quot;</span>)</span></span><br><span class="line"><span class="javascript">        <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;setMessageInHtml(<span class="string">&quot;欢迎来到这里！&quot;</span>)</span></span><br><span class="line">        &#125;,2000)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    websocket.onmessage = <span class="function"><span class="params">e</span> =&gt;</span> setMessageInHtml(e.data)</span></span><br><span class="line"><span class="javascript">    websocket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        setMessageInHtml(<span class="string">&quot;连接断开！&quot;</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onbeforeunload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line">        clos();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setMessageInHtml</span>(<span class="params">message</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">&#x27;message&#x27;</span>).innerHTML += message+<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">clos</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        websocket.close(<span class="number">3000</span>,<span class="string">&quot;强制关闭&quot;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> msg = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;text&#x27;</span>).value;</span></span><br><span class="line">        websocket.send(msg);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>使用的时候，我不禁有一个疑问，为什么加上这些注解就可以实现WebSocket的通信了呢？这里，通过springboot+tomcat的源码进行分析<br>首先先学习下Spring关于WebSocket的<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/5.3.0-SNAPSHOT/reference/html/web.html#websocket">文档</a>，其中主要介绍了WebSocket和Http的区别，以及使用时机，同时还介绍了Spring结合WebSocket如何使用<br>首先我们发现，Java的webSocket主要依赖了两个jar包，一个是tomcat-embed-websocket，另一个是spring-websocket</p>
<h4 id="1-启动流程"><a href="#1-启动流程" class="headerlink" title="1. 启动流程"></a>1. 启动流程</h4><p>首先我们自定义了一个配置类，把 <code>ServerEndpointExporter</code> 注册为bean，然后这个bean在初始化的时候会进入registerEndPoints方法，找到包含@ServerEndPoint注解或者实现了ServerEndPointConfig接口的bean，然后把他们放入ServerContainer中<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602315579052-3cf8b89e-2603-4664-9de5-1e1f582c253b.png#align=left&display=inline&height=421&margin=%5Bobject%20Object%5D&name=image.png&originHeight=841&originWidth=1509&size=1861040&status=done&style=none&width=754.5" alt="image.png"><br>可以发现，我们使用websocket的类都被注册到ServerContainer这个接口的实现类当中了，所以下一步的分析就是去找它的实现类（WsServerContainer）了，看它是如何处理这些注解的</p>
<p>现在去看WsServerContainer在addEndpoint时做了一个事情：主要是把注解中的配置装入ServerEndpointConfig类中，从而被系统识别。这其中用了Builder的建造者模式。这一步完成以后，我们可以发现，此时注解形成的和接口形成的配置全都被装载进了ServerPointConfig中，等于说把他们抽象出来了，然后就可以只处理ServerEndPointConfig了</p>
<p>那么下一步，就是去处理ServerPointConfig的配置了。处理那些配置呢？我们不妨想一下，肯定会处理方法中OnOpen这些注解（下图中进入PojoMethodMapping类中去处理方法的映射）：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602318358999-2720fc7f-0d0f-4b09-aef0-0c4eb3b4480e.png#align=left&display=inline&height=413&margin=%5Bobject%20Object%5D&name=image.png&originHeight=825&originWidth=1583&size=1941207&status=done&style=none&width=791.5" alt="image.png"><br>如下图，PojoMethodMapping确实是为了处理存放每个注解的方法以及他们的参数 <br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602319241475-818569ee-f82e-4893-864e-05617e7c26aa.png#align=left&display=inline&height=436&margin=%5Bobject%20Object%5D&name=image.png&originHeight=872&originWidth=1309&size=370084&status=done&style=none&width=654.5" alt="image.png"></p>
<blockquote>
<p>那么这里引入一个问题，如果A继承了B，然后A有@OnClose，B有@OnOpen，这样该如何选择呢？又或者，如果A和B都有@OnOpen，那么改选则哪一个呢？又或者，A有两个@OnClose，那么该怎么办呢？这个先不予解答，希望大家看下PojoMehodMapping的构造方法</p>
</blockquote>
<p>在查看源码的过程中，我发现程序会定向识别几个方法的参数：OnOpen有EndpointConfig，OnClose有CloseReason，OnError有Throwable，然后他们需要识别Session和PathParam。方法参数是一个独自的类，叫PojoPathParam，它有两个属性，一个是参数的注解（即PathParam），一个是返回值<br>除此之外，它在识别OnMessage时，会使用内部类MessageHandlerInfo来进行配置</p>
<p>继续分析WsServerContainer的addEndPoint方法。<br>下一步，就是通过UriTemplate去处理映射的路由路径（此处通过TreeSet来排序和去重，以直接抛异常的方式），把uri和和其uriTemplate形成map</p>
<p>可以说，一个WebSocket对应着一个PojoMehodMapping。那么分析到这里为止，我们可以总结下：一个WebSocket的类，对应着一个PojoMethodMapping和UriTemplate，同时也对应着一个ServerEndPointConfig，然后WsServerContainer对应多个ServerEndPointConfig</p>
<p>到此为止，把所有的东西都注册完成并识别成功，那么下一步，就是执行流程了</p>
<h4 id="2-执行流程"><a href="#2-执行流程" class="headerlink" title="2. 执行流程"></a>2. 执行流程</h4><p>这里，我们不得不需要一些前置知识，即TOMCAT的执行流程，同时还应该学习一下SpringMVC是如何和tomcat集合的。<strong>当然，socket和mvc没多大关系</strong><br>大体上来说，tomcat在启动后会一直监听我们设定的端口，当有http请求过来后，tomcat首先会解析http请求的header，body，url等等，然后通过url映射到相应的servlet，springMVC在这里做了一个事情，就是使得tomcat的所有映射都进入dispatcherServlet，然后再通过dispatcherServlet进入到对应的Controller中。<em>(这里也用到了适配器模式，具体可以看我的博客）</em></p>
<p>这里的执行是利用filter来执行的，这里感兴趣的同学可以学习一下责任链模式。</p>
<p>对于Tomcat来说，它首先会通过ApplicationFilterChain去执行filter，此时会进入到WsFilter中去判断第一次连接，即upgrade请求（此时使用的http），之后调用servlet.service去到controller中执行</p>
<p>从执行来说，首先会进入socket连接，执行org.apache.coyote.AbstractProtocol.ConnectionHandler#process方法。在这个方法中然后再被过滤器过滤。过滤器会去判断它是不是websocket的连接，如果是，则升级协议，之后process方法会根据每次连接的状态来处理流程</p>
<p>那么，我们就从WsFilter开始去看它的执行流程把~<br>首先在handshake之前，会进入WsFilter中去升级协议（即给client的响应中协商改变协议）。在升级的过程中，它会把uri对应的ServerEndPointConfig，request，二阶段协商内容等等装入PojoEndpointServer中，这里面调用的是WsHttpUpgradeHandler的preinit方法。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602474298163-80e51ac5-c78a-48b7-add5-3ebc733cc1b7.png#align=left&display=inline&height=538&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1075&originWidth=1917&size=2097470&status=done&style=none&width=958.5" alt="image.png"><br>当WsFilter执行完之后，因为需要升级协议，所以他会在upgradeToken那里打上标记，记得之前执行了handler的preinit方法吗，这时，它就会去执行init方法，把这些配置全放到session中。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602474956910-852fba7a-9743-4b2d-b03f-eb2bee651094.png#align=left&display=inline&height=540&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1080&originWidth=1920&size=2136439&status=done&style=none&width=960" alt="image.png"><br>注意之前的PojoEndpointServer，它是执行我们自定义SocketServer的容器。在这个过程中，我们把自定义的pojo，即我们自己的socket放到了PojoEndpointServer，便于它进行最后的反射调用<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602475701584-05fdb95f-f9a6-405a-b0bd-2ffcdb5f3988.png#align=left&display=inline&height=540&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1080&originWidth=1920&size=2113335&status=done&style=none&width=960" alt="image.png"><br>以上就是OnOpen的执行流程。</p>
<p>那么下面分析OnMessage的执行流程：<br>首先我们回忆一下在执行流程中的onOpen阶段（即上图第50行），他会把含有OnMessage注解的Handler放到session中。<br>记得我们之前有一个WsHttpUpgradeHandler类吗，tomcat会根据连接的状态去调用WsHttpUpgradeHandler#upgradeDispatch的方法，然后这个方法会去通过WsFrameBase到session中拿到之前注册的handler（这里是ojoMessageHandlerWholeText），然后调用其onMessage方法，让后在这个方法中会通过反射调用其中的OnMessage方法，执行我们自己的逻辑<br><img src="https://cdn.nlark.com/yuque/0/2020/png/719664/1602495381349-a98a41b1-5348-44a6-a63f-2f08881fba22.png#align=left&display=inline&height=540&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1080&originWidth=1919&size=2098332&status=done&style=none&width=959.5" alt="image.png"></p>
<h4 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h4><p>总结一下，这次源码分析说是分析Spring+Tomcat，但是其实更多的核心代码还是在tomcat中，Spring-websocket只是起了自动装配的作用，初始化出对应的WsServerContainer之后就没有它的活了。<br>启动过程中，会结合Spring的生命周期去检测对应的注解或者接口，把对应的方法和类，uri装载到config和handler中<br>执行的时候，会先去通过tomcat自带的过滤器即filter去检测是否是websocket的upgrade模式，如果是，则和client升级协议，建立websocket连接。之后再通过反射去处理对应的业务逻辑<br>用的的设计模式有：建造者模式，过滤器模式，模板方法模式，适配器模式</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-09-21</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Java/" title="Java">Java </a><a class="tag" href="/tags/Tomcat/" title="Tomcat">Tomcat </a><a class="tag" href="/tags/Websocket/" title="Websocket">Websocket </a><i class="fa fa-star"></i><a class="tag" href="/categories/源码分析/" title="源码分析">源码分析 </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://wxxlamp.cn/2020/09/21/tomcat-websocket/,王星星的魔灯,Tomcat中websocket的使用和原理,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/10/14/reference-point/" title="C++的引用和指针[转]">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/08/20/meituan-interview/" title="开水团面试">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false,
  verify:false|| false,
  app_id:'VzGOJC7bFNXeYUEicbM4nOT2-gzGzoHsz',
  app_key:'T3VwGNzVqiWepoUHUQMnh8tP',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'mp'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>